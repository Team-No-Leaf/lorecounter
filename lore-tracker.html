<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lore Tracker</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <main id="loreContainer"></main>

    <script>
        let players = JSON.parse(localStorage.getItem("players")) || [];
        let playerMaxLore = Array(players.length).fill(20);
        let toggledPlayers = new Set();

        function createPlayerSections() {
            const container = document.getElementById("loreContainer");
            container.innerHTML = "";

            if (players.length === 2) {
                container.classList.add("two-players");
            } else if (players.length === 3) {
                container.classList.add("three-players");
            } else if (players.length === 4) {
                container.classList.add("four-players");
            }

            players.forEach((player, index) => {
                let section = document.createElement("div");
                section.classList.add("player-section");

                if ((players.length === 2 && index === 0) || 
                    (players.length === 3 && index === 0) ||
                    (players.length === 4 && index < 2)) {
                    section.classList.add("rotate");
                }

                section.innerHTML = `
                    <h2>${player.name}</h2>
                    <div class="lore-counter">
                        <button onclick="updateLore(${index}, -1)">-</button>
                        <span id="lore${index}" class="lore-value">0</span>
                        <button onclick="updateLore(${index}, 1)">+</button>
                    </div>
                    <img id="donaldToggle${index}" class="donald-toggle" src="donald_toggle.png" alt="Donald Toggle" onclick="toggleDonald(${index})">
                `;

                container.appendChild(section);
            });

            updateLoreColors();
        }

        function updateLore(index, change) {
            let loreElement = document.getElementById(`lore${index}`);
            let currentValue = parseInt(loreElement.innerText);
            let newValue = Math.max(0, Math.min(playerMaxLore[index], currentValue + change));
            loreElement.innerText = newValue;
            updateLoreColors();
        }

        function updateLoreColors() {
            let values = Array.from(document.querySelectorAll(".lore-value")).map(el => parseInt(el.innerText));
            let maxValue = Math.max(...values);
            let minValue = Math.min(...values);

            document.querySelectorAll(".lore-value").forEach((el, index) => {
                let value = parseInt(el.innerText);
                el.style.color = value === maxValue ? "green" : value === minValue ? "red" : "black";
            });
        }

        function toggleDonald(playerIndex) {
            let toggle = document.getElementById(`donaldToggle${playerIndex}`);

            if (toggledPlayers.has(playerIndex)) {
                toggle.classList.remove("active");
                toggle.classList.add("disabled");
                toggledPlayers.delete(playerIndex);
            } else {
                toggle.classList.remove("disabled");
                toggle.classList.add("active");
                toggledPlayers.add(playerIndex);
            }

            updateMaxLore();
        }

        function updateMaxLore() {
            let activePlayers = Array.from(toggledPlayers);

            players.forEach((_, i) => {
                if (toggledPlayers.has(i)) {
                    playerMaxLore[i] = 20;
                } else if (activePlayers.length > 0) {
                    playerMaxLore[i] = 25;
                }
            });

            if (activePlayers.length === players.length) {
                playerMaxLore.fill(25);
            }
        }

        createPlayerSections();
    </script>
</body>
</html>

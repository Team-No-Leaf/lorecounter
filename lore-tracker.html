<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lore Tracker</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.0.1"></script> <!-- Confetti Library -->
</head>
<body>
    <main id="loreContainer"></main>

    <div id="gameEndContainer" style="display: none;">
        <p id="winnerText"></p>
        <button id="nextGameButton" onclick="startNextGame()">Next Game</button>
        <button id="returnHomeButton" onclick="returnToLanding()">Back to Home</button>
    </div>

    <script>
        let players = JSON.parse(localStorage.getItem("players")) || [];
        let gamesWon = JSON.parse(localStorage.getItem("gamesWon")) || Array(players.length).fill(0);
        let playerMaxLore = Array(players.length).fill(20);

        function createPlayerSections() {
            const container = document.getElementById("loreContainer");
            container.innerHTML = "";

            let topSection = document.createElement("div");
            topSection.classList.add("top-section");

            let bottomSection = document.createElement("div");
            bottomSection.classList.add("bottom-section");

            players.forEach((player, index) => {
                let section = document.createElement("div");
                section.classList.add("player-section");
                section.dataset.ink = player.ink;

                section.innerHTML = `
                    <div class="ink-symbol-container">
                        <img src="dlc_ink_${player.ink.toLowerCase()}.png" alt="${player.ink}">
                    </div>
                    <div class="player-info">
                        <div class="lore-counter">
                            <button onclick="updateLore(${index}, -1)">-</button>
                            <span id="lore${index}" class="lore-value">0</span>
                            <button onclick="updateLore(${index}, 1)">+</button>
                        </div>
                        <p id="playerName${index}" class="player-name">${player.name}</p>
                        <div class="games-won-container">
                            Games Won: <span id="gamesWon${index}">${gamesWon[index]}</span>
                        </div>
                    </div>
                `;

                if (index < 2) topSection.appendChild(section);
                else bottomSection.appendChild(section);
            });

            container.appendChild(topSection);
            container.appendChild(bottomSection);
        }

        function updateLore(index, change) {
            let loreElement = document.getElementById(`lore${index}`);
            let currentValue = parseInt(loreElement.innerText);
            let newValue = Math.max(0, Math.min(playerMaxLore[index], currentValue + change));
            loreElement.innerText = newValue;

            if (newValue === playerMaxLore[index]) {
                handleGameWin(index);
            }
        }

        function handleGameWin(winnerIndex) {
            gamesWon[winnerIndex]++;
            localStorage.setItem("gamesWon", JSON.stringify(gamesWon));
            document.getElementById(`gamesWon${winnerIndex}`).innerText = gamesWon[winnerIndex];

            let winnerName = players[winnerIndex].name;
            document.getElementById("winnerText").innerText = `${winnerName} has won the game!`;
            document.getElementById("gameEndContainer").style.display = "block";
            startConfetti();
        }

        function startNextGame() {
            document.getElementById("gameEndContainer").style.display = "none";
            document.querySelectorAll(".lore-value").forEach(el => el.innerText = "0");
            stopConfetti();
        }

        function returnToLanding() {
            window.location.href = "index.html";
        }

        function startConfetti() {
            confetti({ particleCount: 100, spread: 70 });
        }

        function stopConfetti() {
            confetti.reset();
        }

        createPlayerSections();
    </script>
</body>
</html>

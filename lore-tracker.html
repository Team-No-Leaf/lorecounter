<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lore Tracker</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <main id="loreContainer"></main>
    <div id="gameEndContainer" style="display: none;">
        <button id="gameEndButton" onclick="restartGame()"></button>
    </div>
    <button id="finalGameButton" onclick="returnToLanding()">Return to Home</button>

    <script>
        let players = JSON.parse(localStorage.getItem("players")) || [];
        let matchFormat = localStorage.getItem("matchFormat") || "Single";
        let playerMaxLore = Array(players.length).fill(20);
        let toggledPlayers = new Set();
        let gamesWon = JSON.parse(localStorage.getItem("gamesWon")) || Array(players.length).fill(0);

        function createPlayerSections() {
            const container = document.getElementById("loreContainer");
            container.innerHTML = "";

            container.className = players.length === 2 ? "two-players" :
                                  players.length === 3 ? "three-players" :
                                  players.length === 4 ? "four-players" : "";

            players.forEach((player, index) => {
                let section = document.createElement("div");
                section.classList.add("player-section");

                if ((players.length === 2 && index === 0) || 
                    (players.length === 3 && index === 0) ||
                    (players.length === 4 && index < 2)) {
                    section.classList.add("rotate");
                }

                section.innerHTML = `
                    <h2>${player.name}</h2>
                    <p class="games-won">Games Won: <span id="gamesWon${index}">${gamesWon[index]}</span></p>
                    <div class="lore-counter">
                        <button onclick="updateLore(${index}, -1)">-</button>
                        <span id="lore${index}" class="lore-value">0</span>
                        <button onclick="updateLore(${index}, 1)">+</button>
                    </div>
                    <img id="donaldToggle${index}" class="donald-toggle" src="donald_toggle.png" alt="Donald Toggle" onclick="toggleDonald(${index})">
                `;

                container.appendChild(section);
            });

            updateLoreColors();
        }

        function handleGameWin(winnerIndex) {
            gamesWon[winnerIndex]++;
            localStorage.setItem("gamesWon", JSON.stringify(gamesWon));
            document.getElementById(`gamesWon${winnerIndex}`).innerText = gamesWon[winnerIndex];

            let gameEndButton = document.getElementById("gameEndButton");
            let finalGameButton = document.getElementById("finalGameButton");

            let requiredWins = matchFormat === "Two Games" ? 2 :
                               matchFormat === "Best of 3" ? 2 :
                               matchFormat === "Best of 5" ? 3 : 1;

            if (gamesWon[winnerIndex] >= requiredWins) {
                finalGameButton.style.display = "block";
            } else {
                gameEndButton.innerText = matchFormat === "Single" ? "Start New Game" : "Start Next Game";
                document.getElementById("gameEndContainer").style.display = "flex";
            }
        }

        function restartGame() {
            document.getElementById("gameEndContainer").style.display = "none";
            document.querySelectorAll(".lore-value").forEach(el => el.innerText = "0");
        }

        function returnToLanding() {
            window.location.href = "index.html";
        }

        createPlayerSections();
    </script>
</body>
</html>
